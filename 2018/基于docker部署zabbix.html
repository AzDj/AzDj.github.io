<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>基于docker部署zabbix | AzDj</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">基于docker部署zabbix</h1><a id="logo" href="/.">AzDj</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">基于docker部署zabbix</h1><div class="post-meta">Nov 6, 2018</div><a class="disqus-comment-count" href="/2018/基于docker部署zabbix.html#vcomment"><span class="valine-comment-count" data-xid="/2018/基于docker部署zabbix.html"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#zabbix-server-部署阶段"><span class="toc-number">1.</span> <span class="toc-text">zabbix-server 部署阶段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL-数据库"><span class="toc-number">1.1.</span> <span class="toc-text">MySQL 数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#编写Dockerfile"><span class="toc-number">1.1.1.</span> <span class="toc-text">编写Dockerfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动mysql容器"><span class="toc-number">1.1.2.</span> <span class="toc-text">启动mysql容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zabbix-java-gateway"><span class="toc-number">1.2.</span> <span class="toc-text">Zabbix-java-gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启动java-gateway容器"><span class="toc-number">1.2.1.</span> <span class="toc-text">启动java-gateway容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zabbix-server"><span class="toc-number">1.3.</span> <span class="toc-text">Zabbix server</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启动server容器"><span class="toc-number">1.3.1.</span> <span class="toc-text">启动server容器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zabbix-Web"><span class="toc-number">1.4.</span> <span class="toc-text">Zabbix-Web</span></a></li></ol></li></ol></div></div><div class="post-content"><p>安装过程与流程转载自<a href="https://blog.rj-bai.com/post/144.html#menu_index_7" target="_blank" rel="noopener">基于 docker 部署 zabbix 及客户端批量部署</a><br><a id="more"></a></p>
<h2 id="zabbix-server-部署阶段"><a href="#zabbix-server-部署阶段" class="headerlink" title="zabbix-server 部署阶段"></a>zabbix-server 部署阶段</h2><p>所需用到的有以下几个组件，也可以根据你个人添加、使用其他的</p>
<table>
<thead>
<tr>
<th>组件名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据库</td>
<td>MySQL或是PostgreSQL</td>
</tr>
<tr>
<td>Zabbix Java gateway</td>
<td>Java 管理扩展，可以不添加</td>
</tr>
<tr>
<td>Zabbix server</td>
<td>zabbix 服务端</td>
</tr>
<tr>
<td>zabbix-web</td>
<td>与 MySQL 服务器实例和 Zabbix server 实例关联</td>
</tr>
<tr>
<td>zabbix-agent</td>
<td>zabbix 客户端</td>
</tr>
</tbody>
</table>
<h3 id="MySQL-数据库"><a href="#MySQL-数据库" class="headerlink" title="MySQL 数据库"></a>MySQL 数据库</h3><h4 id="编写Dockerfile"><a href="#编写Dockerfile" class="headerlink" title="编写Dockerfile"></a>编写Dockerfile</h4><p>数据库同样选择MySQL，还是得写Dockerfile，改一下时区，字符集也要改一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# mkdir /data/docker/mysql -p</span><br><span class="line">[root@zabbix /data/docker/mysql]# vim Dockerfile</span><br><span class="line">FROM mysql:5.7</span><br><span class="line">ENV LANG en_US.utf8</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo Asia/Shanghai &gt; /etc/timezone</span><br></pre></td></tr></table></figure>
<p>然后构建一下试试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix /data/docker/mysql]# docker build -t centos-mysql .</span><br><span class="line">[root@zabbix /data/docker/mysql]# docker images</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">debian-mysql     latest              3d3c7dc9608c        14 seconds ago      372MB</span><br><span class="line">mysql               5.7                 563a026a1511        3 weeks ago         372MB</span><br></pre></td></tr></table></figure>
<p>镜像有了，可以启动了。</p>
<h4 id="启动mysql容器"><a href="#启动mysql容器" class="headerlink" title="启动mysql容器"></a>启动mysql容器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]#  docker run --hostname mysql\</span><br><span class="line">&gt; --name zabbix-mysql -t \</span><br><span class="line">&gt;  -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">&gt;  -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">&gt;  -e MYSQL_PASSWORD=&quot;password&quot; \</span><br><span class="line">&gt;  -e MYSQL_ROOT_PASSWORD=&quot;password&quot; \</span><br><span class="line">&gt;  -v /data/mysql:/var/lib/mysql:rw \</span><br><span class="line">&gt;  -d centos-mysql</span><br><span class="line">0e9015c4a6ff99e04dd3f1cfd841a986f52e8c1d77b350d0d93e250c875249fd</span><br><span class="line"></span><br><span class="line">[root@zabbix ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">0e9015c4a6ff        centos-mysql        &quot;docker-entrypoint.s…&quot;   50 seconds ago      Up 50 seconds       3306/tcp, 33060/tcp      zabbix-mysql</span><br><span class="line">121ac6416bf0        registry            &quot;/entrypoint.sh /etc…&quot;   15 hours ago        Up 15 hours         0.0.0.0:5000-&gt;5000/tcp   musing_meninsky</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>变量说明</th>
<th>变量</th>
</tr>
</thead>
<tbody>
<tr>
<td>MYSQL_USER</td>
<td>启动时要添加的用户</td>
</tr>
<tr>
<td>MYSQL_DATABASE</td>
<td>启动时要创建的数据库</td>
</tr>
<tr>
<td>MYSQL_PASSWORD</td>
<td>指定添加用的的密码</td>
</tr>
<tr>
<td>MYSQL_ROOT_PASSWORD</td>
<td>root 用户的密码</td>
</tr>
</tbody>
</table>
<p>到此MySQL完成</p>
<p>启动 Zabbix Java gateway</p>
<p>编写Dockerfile</p>
<h3 id="Zabbix-java-gateway"><a href="#Zabbix-java-gateway" class="headerlink" title="Zabbix-java-gateway"></a>Zabbix-java-gateway</h3><p>zabbix java gateway这个可以看项目情况，如果不监控java应用服务器可以不安装这个，还是得写Dockerfile，改一下时区和编码。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix /data/docker/java-gateway]<span class="comment"># cat Dockerfile</span></span><br><span class="line">FROM zabbix/zabbix-java-gateway:latest</span><br><span class="line">ENV LANG en_US.utf8</span><br><span class="line">RUN apk add -U tzdata</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> Asia/Shanghai &gt; /etc/timezone \</span><br><span class="line">[root@zabbix /data/docker/java-gateway]<span class="comment"># docker build -t zabbix-java-gateway .</span></span><br><span class="line">[root@zabbix /data/docker/java-gateway]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">zabbix-java-gateway          latest              c90c4764fcae        21 seconds ago      82.8MB</span><br></pre></td></tr></table></figure>
<h4 id="启动java-gateway容器"><a href="#启动java-gateway容器" class="headerlink" title="启动java-gateway容器"></a>启动java-gateway容器</h4><p>需要映射一下10052端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]#docker run --hostname zabbix-java-gateway \</span><br><span class="line">&gt; --name zabbix-java-gateway -t \</span><br><span class="line">&gt; -p 10052:10052 \</span><br><span class="line">&gt; -d zabbix-java-gateway</span><br><span class="line">cada137005d68f193c9921aeef6c20647c9966f8f2f7e804801678063505080b</span><br><span class="line"></span><br><span class="line">[root@zabbix ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                      NAMES</span><br><span class="line">cada137005d6        zabbix-java-gateway   &quot;docker-entrypoint.sh&quot;   18 seconds ago      Up 17 seconds       0.0.0.0:10052-&gt;10052/tcp   zabbix-java-gateway</span><br><span class="line">0e9015c4a6ff        centos-mysql          &quot;docker-entrypoint.s…&quot;   2 hours ago         Up 2 hours          3306/tcp, 33060/tcp        zabbix-mysql</span><br><span class="line">121ac6416bf0        registry              &quot;/entrypoint.sh /etc…&quot;   18 hours ago        Up 18 hours         0.0.0.0:5000-&gt;5000/tcp     musing_meninsky</span><br></pre></td></tr></table></figure>
<h3 id="Zabbix-server"><a href="#Zabbix-server" class="headerlink" title="Zabbix server"></a>Zabbix server</h3><p>编写Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix /data/docker/zabbix-server]# cat Dockerfile</span><br><span class="line">FROM zabbix/zabbix-server-mysql:latest</span><br><span class="line">ENV LANG en_US.utf8</span><br><span class="line">RUN apk add -U tzdata</span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \</span><br><span class="line">    echo Asia/Shanghai &gt; /etc/timezone \</span><br><span class="line">[root@zabbix /data/docker/zabbix-server]# docker build -t zabbix-server .</span><br><span class="line">[root@zabbix /data/docker/zabbix-server]# docker images</span><br><span class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED              SIZE</span><br><span class="line">zabbix-server                latest              35adeeef076c        20 seconds ago      64.9MB</span><br></pre></td></tr></table></figure>
<h4 id="启动server容器"><a href="#启动server容器" class="headerlink" title="启动server容器"></a>启动server容器</h4><p>需要做的事情，映射10051端口，指定数据库服务器，连接MySQL和zabbix-java-gateway容器，开撸。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# docker run --name zabbix-server -t \</span><br><span class="line">&gt; -p 10051:10051 \</span><br><span class="line">&gt; --hostname zabbix-server \</span><br><span class="line">&gt; -e DB_SERVER_HOST=&quot;zabbix-mysql&quot; \</span><br><span class="line">&gt; -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">&gt; -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">&gt; -e MYSQL_PASSWORD=&quot;password&quot; \</span><br><span class="line">&gt; -e MYSQL_ROOT_PASSWORD=&quot;password&quot; \</span><br><span class="line">&gt; -e ZBX_JAVAGATEWAY=&quot;zabbix-java-gateway&quot; \</span><br><span class="line">&gt; --link zabbix-mysql:mysql \</span><br><span class="line">&gt; --link zabbix-java-gateway:zabbix-java-gateway \</span><br><span class="line">&gt; -d zabbix-server</span><br><span class="line">10e0ceb8043f4e0c69260926e026d65029bd5d5dae0c3b5279761f8cf96f2a0f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@zabbix ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                      NAMES</span><br><span class="line">10e0ceb8043f        zabbix-server         &quot;docker-entrypoint.sh&quot;   2 minutes ago       Up 2 minutes        0.0.0.0:10051-&gt;10051/tcp   zabbix-server</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>变量说明</th>
<th>变量</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB_SERVER_HOST</td>
<td>指定 MySQL 或 PostgreSQL 服务器的 IP 或 DNS 名称</td>
</tr>
<tr>
<td>MYSQL_DATABASE</td>
<td>zabbix 数据库名称</td>
</tr>
<tr>
<td>MYSQL_USER</td>
<td>数据库用户，默认是 zabbix</td>
</tr>
<tr>
<td>MYSQL_PASSWORD</td>
<td>zabbix 数据库密码，默认 zabbix</td>
</tr>
<tr>
<td>ZBX_JAVAGATEWAY</td>
<td>是否启用 Zabbix Java gateway，默认 false</td>
</tr>
<tr>
<td>–link zabbix-mysql:mysql</td>
<td>连接参数 容器名：主机名</td>
</tr>
</tbody>
</table>
<p>最后一步，启动zabbix-web</p>
<h3 id="Zabbix-Web"><a href="#Zabbix-Web" class="headerlink" title="Zabbix-Web"></a>Zabbix-Web</h3><p>编写Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix /data/docker/zabbix-web]# cat Dockerfile</span><br><span class="line">FROM zabbix/zabbix-web-nginx-mysql:latest</span><br><span class="line">ENV LANG en_US.utf8</span><br><span class="line">RUN apk add -U tzdata</span><br><span class="line">RUN sed -i s#Europe/Riga#Asia/Shanghai#g /usr/bin/docker-entrypoint.sh &amp;&amp; \</span><br><span class="line">    ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \</span><br><span class="line">    echo Asia/Shanghai &gt; /etc/timezone \</span><br><span class="line">[root@zabbix /data/docker/zabbix-web]# docker build -t zabbix-web .</span><br><span class="line">[root@zabbix /data/docker/zabbix-web]# docker images</span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED              SIZE</span><br><span class="line">zabbix-web                      latest              a2c26872e8b9        About a minute ago   166MB</span><br></pre></td></tr></table></figure>
<p>启动容器</p>
<p>需要做的事情，映射 80 端口到宿主机，连接数据库，连接zabbix-server容器，开撸开撸。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# docker run --name zabbix-web -t \</span><br><span class="line">&gt; -p 80:80 \</span><br><span class="line">&gt; --hostname zabbix-web \</span><br><span class="line">&gt; -e DB_SERVER_HOST=&quot;zabbix-mysql&quot; \</span><br><span class="line">&gt; -e MYSQL_DATABASE=&quot;zabbix&quot; \</span><br><span class="line">&gt; -e MYSQL_USER=&quot;zabbix&quot; \</span><br><span class="line">&gt; -e MYSQL_PASSWORD=&quot;password&quot; \</span><br><span class="line">&gt; -e MYSQL_ROOT_PASSWORD=&quot;password&quot; \</span><br><span class="line">&gt; --link zabbix-mysql:mysql \</span><br><span class="line">&gt; --link zabbix-server:zabbix-server \</span><br><span class="line">&gt; -d zabbix-web</span><br><span class="line">878e74ece27f137c9648149f783207d26616d8932833e159ad8cdbef2538471b</span><br><span class="line"></span><br><span class="line">[root@zabbix ~]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS              PORTS                         NAMES</span><br><span class="line">878e74ece27f        zabbix-web            &quot;docker-entrypoint.sh&quot;   2 hours ago         Up 2 hours          0.0.0.0:80-&gt;80/tcp, 443/tcp   zabbix-web</span><br></pre></td></tr></table></figure>
<p>最后看一眼正在运行的容器。</p>
<p>一共四个就对了，然后就可以打开你的服务器 IP 看效果了，重点是这里撒，看上去是没啥子问题，手动加个主机试试，看看能不能监控到。</p>
<p>zabbix 客户配置</p>
<p>这个是需要加一个客户端的撒，先装一个试试能不能监控到，网页操作全部略过，从安装客户端开始。<br>安装 zabbix-agent</p>
<p>emmmm，这个还是用官方的yum源吧，很简单，两条命令解决</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">centos 7</span><br><span class="line">[root@nginx ~]# rpm -i https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0.1.el7.noarch.rpm</span><br><span class="line">warning: /var/tmp/rpm-tmp.AbbbMW: Header V4 RSA/SHA512 Signature, key ID a14fe591: NOKEY</span><br><span class="line">[root@nginx ~]# yum -y install zabbix-agent</span><br><span class="line"></span><br><span class="line">放行端口（可直接关闭防火墙，生产环境建议开启防火墙）</span><br><span class="line">vi /etc/sysconfig/iptables</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 10050 -j ACCEPT</span><br><span class="line">-A OUTPUT -m state --state NEW -m tcp -p tcp --dport 10051 -j ACCEPT</span><br><span class="line">systemctl restart iptables</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">装完之后改一下配置文件，指定一下zabbix-server的地址，UserParameter顺便也开启一下吧，以后肯定要添加自定义监控的，就这样</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">Server=zabbix服务器ip #被动模式</span><br><span class="line">ServerActive=zabbix 服务器ip #主动模式</span><br><span class="line">UnsafeUserParameters=1</span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.d/*.conf</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# systemctl start zabbix-agent</span><br><span class="line">[root@nginx ~]# systemctl enable zabbix-agent</span><br><span class="line"></span><br><span class="line">centos6</span><br><span class="line">[root@nginx ~]# rpm -i https://repo.zabbix.com/zabbix/4.0/rhel/6/x86_64/zabbix-release-4.0.1-1.el6.x86_64.rpm</span><br><span class="line">warning: /var/tmp/rpm-tmp.AbbbMW: Header V4 RSA/SHA512 Signature, key ID a14fe591: NOKEY</span><br><span class="line">[root@nginx ~]# yum -y install zabbix-agent</span><br><span class="line"></span><br><span class="line">放行端口</span><br><span class="line">vi /etc/sysconfig/iptables</span><br><span class="line">-A INPUT -m state --state NEW -m tcp -p tcp --dport 10050 -j ACCEPT</span><br><span class="line">-A OUTPUT -m state --state NEW -m tcp -p tcp --dport 10051 -j ACCEPT</span><br><span class="line">server iptables restart</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">Server=zabbix服务器ip</span><br><span class="line">ServerActive=zabbix 服务器ip</span><br><span class="line">UnsafeUserParameters=1</span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.d/*.conf</span><br><span class="line"></span><br><span class="line">[root@nginx ~]# service zabbix-agent start</span><br><span class="line">[root@nginx ~]# chkconfig zabbix-agent on</span><br></pre></td></tr></table></figure>
<p>网页看效果</p>
<p>可以检测到主机，顺便提一下，在宿主机上安装</p>
<p>然后看一眼图形，也有数据了。</p>
<p>然后发现了两个问题，第一个，如果容器想要去监控宿主机，请编辑宿主机的zabbix_agentd.conf，将Server的地址改为容器的 IP，否则不通。</p>
<p>第二个就是zabbix监控时间和系统时间对不上，现在是下午，估计是PHP时区这里有问题，现在去改一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix ~]# docker exec -it zabbix-web /bin/bash</span><br><span class="line">bash-4.4# vi /etc/php7/conf.d/99-zabbix.ini</span><br><span class="line">; date.timezone=Europe/Riga</span><br><span class="line">date.timezone=Asia/Shanghai</span><br><span class="line">[root@zabbix ~]# docker restart zabbix-web</span><br></pre></td></tr></table></figure>
<p>我本以为这样就行了，但是重启容器之后我改的Asia/Shanghai又变回了Europe/Riga，然后我试着传了一下文件，重启还是会变，估计是有系统变量，执行env看了一下没找到，然后看了一眼启动默认命令，是执行了一个脚本，我看了一下，发现了这个。</p>
<p>改一下这个试试，改成Asia/Shanghai，文件路径/usr/bin/docker-entrypoint.sh</p>
<p>顺便改了一下上文zabbix-web的Dockerfile, 使用sed替换了一下脚本内容，所以现在不存在这个问题。最后，那就是zabbix-agent安装的问题，还有 20 多个服务器没安装zabbix-agent，一个一个去装不太现实，zabbix暂时退场，ansible上线。<br>zabbix-agent 批量安装</p>
<p>ansible这一块安装配置就不写了，直接撸playbook，其实也很简单，需要做的事情</p>
<ol>
<li>添加zabbix官方源，</li>
<li>安装zabbix-agent客户端，</li>
<li>传输已经写好的zabbix_agentd.conf，</li>
<li>启动服务，大概就是这样。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ansible ~]# vim zabbix_agent.yml</span><br><span class="line"># zabbix-agent install</span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: add zabbix-agent repo</span><br><span class="line">    yum: name=https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el6.noarch.rpm</span><br><span class="line">         state=installed</span><br><span class="line">  - name: install zabbix-agent</span><br><span class="line">    yum: name=zabbix-agent</span><br><span class="line">         state=installed</span><br><span class="line">  - name: copy zabbix_agent.conf to /etc/zabbix/</span><br><span class="line">    copy: src=/root/zabbix_agentd.conf</span><br><span class="line">          dest=/etc/zabbix/</span><br><span class="line">          backup=yes</span><br><span class="line">  - name: start zabbix-agent</span><br><span class="line">    systemd: state=started</span><br><span class="line">             name=zabbix-agent</span><br><span class="line">             enabled=yes</span><br><span class="line">[root@ansible ~]# ansible-playbook zabbix_agent.yml</span><br></pre></td></tr></table></figure>
<p>changed=1&amp;2的是我下午搞得那两个，全部安装成功，下一步就是在zabbix创建自动发现了。<br>最终结果</p>
<p>自动发现很简单，自行百度去吧，懒得贴图了，最终结果。</p>
<p>这只是部署了一套最基础的监控系统，熟悉操作的话几分钟就能完成，现在还没有添加任何的自定义监控，添加自定义监控这块的话还是很麻烦，暂时没什么好办法，毕竟各个服务的集群要监控的东西都不一样，想想都烦，暂时就这样吧，邮件报警忽略。</p>
</div><div class="tags"><a href="/tags/docker/">docker</a><a href="/tags/zabbix/">zabbix</a></div><div class="post-nav"><a class="pre" href="/2019/dnf.html">DNF.md</a><a class="next" href="/2018/docker-批量操作.html">docker 批量操作</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'Qq3TXn4kkYB1Y5amjdYD5pQM-gzGzoHsz',
  appKey:'lcphlalpyrDQNucYsK1wLn6D',
  placeholder:'',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://azdj.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/jenkins/" style="font-size: 15px;">jenkins</a> <a href="/tags/ansible/" style="font-size: 15px;">ansible</a> <a href="/tags/安装/" style="font-size: 15px;">安装</a> <a href="/tags/ITSM/" style="font-size: 15px;">ITSM</a> <a href="/tags/IT服务管理/" style="font-size: 15px;">IT服务管理</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/RPM/" style="font-size: 15px;">RPM</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/jumpserver/" style="font-size: 15px;">jumpserver</a> <a href="/tags/跳板机/" style="font-size: 15px;">跳板机</a> <a href="/tags/k8s/" style="font-size: 15px;">k8s</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/pyenv/" style="font-size: 15px;">pyenv</a> <a href="/tags/zabbix/" style="font-size: 15px;">zabbix</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/Let-s-Encrypt/" style="font-size: 15px;">Let's Encrypt</a> <a href="/tags/证书/" style="font-size: 15px;">证书</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/rsync同步.html">rsync+inotify同步</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/pyenv.html">pyenv</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/jumpserver简单使用.html">jumpserver简单使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/k8s1-13安装.html">k8s1.13安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/申请免费证书.html">申请免费证书</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/dnf.html">DNF.md</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/基于docker部署zabbix.html">基于docker部署zabbix</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/docker-批量操作.html">docker 批量操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/ansible安装jenkins.html">ansible安装jenkins</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/ITSM.html">ITSM</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/welliamcao/OpsManage" title="自动化运维平台" target="_blank">自动化运维平台</a><ul></ul><a href="https://github.com/kurolz/Books" title="运维之道" target="_blank">运维之道</a><ul></ul><a href="https://www.haomwei.com/technology/maupassant-hexo.html" title="大道至简-屠城hexo主题" target="_blank">大道至简-屠城hexo主题</a><ul></ul><a href="https://www.iyunv.com" title="爱运维网" target="_blank">爱运维网</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">AzDj.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>